openapi: 3.0.0
info:
  title: Framework2 API
  version: 1.0.0
  description: >
    API для микросервисов пользователей и заказов,
    доступный через API-gateway.

servers:
  - url: http://localhost:8080
    description: Local API Gateway

tags:
  - name: Users
    description: Управление пользователями и аутентификация
  - name: Orders
    description: Управление заказами (дефектами)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      properties:
        code:
          type: string
          example: INVALID_TOKEN
        message:
          type: string
          example: Token is invalid or expired

    ApiResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          nullable: true
        error:
          nullable: true
          allOf:
            - $ref: '#/components/schemas/Error'

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        roles:
          type: array
          items:
            type: string
            example: engineer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UserList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/User'
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 10
        total:
          type: integer
          example: 42

    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT токен
        user:
          $ref: '#/components/schemas/User'

    OrderItem:
      type: object
      properties:
        product:
          type: string
          example: "Server bug #123"
        quantity:
          type: integer
          example: 1

    Order:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        status:
          type: string
          enum: [created, in_progress, done, cancelled]
        totalAmount:
          type: number
          format: double
          example: 1500.0
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    OrderList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Order'
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer

    DeleteResult:
      type: object
      properties:
        id:
          type: string
          format: uuid
        deleted:
          type: boolean
          example: true

security:
  - bearerAuth: []

paths:
  /v1/users/register:
    post:
      tags: [Users]
      summary: Регистрация пользователя
      description: Регистрация нового пользователя с указанной бизнес-ролью.
      security: []        # без JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, name, role]
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: secret123
                name:
                  type: string
                  example: Иван Пользователь
                role:
                  type: string
                  description: >
                    Базовая роль: engineer, manager, director, customer или admin.
                    Первый пользователь в системе дополнительно получает роль admin.
                  example: engineer
      responses:
        '200':
          description: Пользователь успешно зарегистрирован
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/User'
        '409':
          description: Пользователь с таким email уже существует
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /v1/users/login:
    post:
      tags: [Users]
      summary: Вход пользователя
      description: Аутентификация по email и паролю, выдача JWT токена.
      security: []        # без JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: secret123
      responses:
        '200':
          description: Успешная аутентификация
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Неверная пара логин/пароль
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /v1/users/me:
    get:
      tags: [Users]
      summary: Получение текущего пользователя
      description: Возвращает профиль пользователя по токену.
      responses:
        '200':
          description: Профиль пользователя
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/User'
        '401':
          description: Неавторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

    patch:
      tags: [Users]
      summary: Обновление профиля текущего пользователя
      description: Сейчас позволяет изменить только поле name.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  example: Новое имя
      responses:
        '200':
          description: Профиль обновлён
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/User'
        '401':
          description: Неавторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /v1/users:
    get:
      tags: [Users]
      summary: Список пользователей (только admin)
      description: Возвращает список пользователей с фильтрами и пагинацией.
      parameters:
        - in: query
          name: email
          schema:
            type: string
          description: Фильтр по email (LIKE)
        - in: query
          name: role
          schema:
            type: string
          description: Фильтр по роли (строка, содержащаяся в списке ролей)
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Список пользователей
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/UserList'
        '401':
          description: Неавторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '403':
          description: Нет прав (не admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /v1/orders:
    post:
      tags: [Orders]
      summary: Создание заказа
      description: Создаёт новый заказ для текущего пользователя.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [items, totalAmount]
              properties:
                items:
                  type: array
                  items:
                    $ref: '#/components/schemas/OrderItem'
                totalAmount:
                  type: number
                  format: double
                  example: 1500.0
      responses:
        '200':
          description: Заказ создан
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Order'
        '400':
          description: Ошибка валидации входных данных
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '401':
          description: Неавторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

    get:
      tags: [Orders]
      summary: Список заказов текущего пользователя
      description: Возвращает только заказы пользователя из токена, с пагинацией.
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: limit
          schema:
            type: integer
            default: 10
        - in: query
          name: sort
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: Сортировка по дате создания
      responses:
        '200':
          description: Список заказов
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/OrderList'
        '401':
          description: Неавторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /v1/orders/{id}:
    get:
      tags: [Orders]
      summary: Получение заказа по идентификатору
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Заказ найден
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Order'
        '401':
          description: Неавторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '403':
          description: Нет прав на просмотр заказа
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '404':
          description: Заказ не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

    delete:
      tags: [Orders]
      summary: Удаление заказа
      description: >
        Владелец может удалять только свои заказы в статусе created или cancelled.
        admin/manager могут удалять любые заказы.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Заказ удалён
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/DeleteResult'
        '400':
          description: Заказ в состоянии, которое нельзя удалить
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '401':
          description: Неавторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '403':
          description: Нет прав на удаление заказа
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '404':
          description: Заказ не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /v1/orders/{id}/status:
    patch:
      tags: [Orders]
      summary: Обновление статуса заказа
      description: >
        admin/manager могут менять статус любого заказа.
        engineer может менять только свои заказы.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [created, in_progress, done, cancelled]
      responses:
        '200':
          description: Статус обновлён
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Order'
        '400':
          description: Неверный статус или недопустимый переход
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '401':
          description: Неавторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '403':
          description: Нет прав на изменение статуса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '404':
          description: Заказ не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /v1/orders/{id}/cancel:
    post:
      tags: [Orders]
      summary: Отмена заказа
      description: >
        Владелец, admin или manager могут отменить заказ.
        Отмена допустима только из статусов created и in_progress.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Заказ отменён
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Order'
        '400':
          description: Нельзя отменить заказ в текущем статусе
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '401':
          description: Неавторизован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '403':
          description: Нет прав на отмену заказа
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
        '404':
          description: Заказ не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
